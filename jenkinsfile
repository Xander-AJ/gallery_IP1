pipeline {
    agent any

    environment {
        MONGODB_CONNECTION = credentials('mongodb-connection')
        GITHUB_REPO_URL = 'https://github.com/Xander-AJ/gallery_IP1'
    }

    stages {
        stage('Source Code Management') {
            steps {
                // Checkout the code from your GitHub repository.
                // Replace <YOUR_REPO_URL> with your actual repository URL.
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'GitSCMSource', remote: GITHUB_REPO_URL]], submoduleCfg: [], userRemoteConfigs: [[url: GITHUB_REPO_URL]]])
            }
        }

        stage('Build') {
            steps {
                script {
                    // Verify the existence of a package.json file.
                    def packageJsonExists = fileExists('package.json')

                    if (packageJsonExists) {
                        // Install project dependencies with npm.
                        sh 'npm install'
                        
                        // Additional build steps if needed.
                    } else {
                        error('package.json not found. This is not a Node.js project.')
                    }
                }
            }
        }

        stage('Test') {
            steps {
                // Run your tests. Modify this command based on your project.
                sh 'npm test'

                // If tests fail, send an email notification.
                catchError {
                    emailext body: 'Tests failed. Please check the build logs for details.',
                             subject: 'Test Results',
                             to: 'xander.kamau7@gmail.com' // Replace with your email address.
                }
            }
        }

        stage('Deployment to Render') {
            steps {
                script {
                    // Access the MongoDB connection string
                    def mongoConnectionString = env.MONGODB_CONNECTION

                    // Include Render-specific deployment commands here, such as setting environment variables
                    // and starting the server using 'node server'.

                    // For example:
                    sh 'render deploy -- --build-env MONGO_URL="$mongoConnectionString"'
                }
            }
        }

        stage('Post-Deployment Actions') {
            steps {
                // Additional actions after deployment, if necessary.
            }
        }
    }

    post {
        failure {
            // Post-build actions for failure, if needed.
        }
    }
}
